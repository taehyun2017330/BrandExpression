<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>INICIS ë¹Œë§ í…ŒìŠ¤íŠ¸ - Standalone</title>
    <script type="text/javascript" src="https://stgstdpay.inicis.com/stdjs/INIStdPay.js" charset="UTF-8"></script>
    <script>
        // Check if INICIS script loaded
        window.addEventListener('load', function() {
            if (typeof INIStdPay === 'undefined') {
                alert('INICIS ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            } else {
                console.log('INICIS script loaded successfully');
            }
        });
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        input[type="text"], input[type="email"], input[type="tel"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus {
            outline: none;
            border-color: #4CAF50;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            background-color: #f9f9f9;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .billing-key-info {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #90caf9;
        }
        .success {
            color: #2e7d32;
            font-weight: 600;
        }
        .error {
            color: #d32f2f;
            font-weight: 600;
        }
        .info {
            color: #1976d2;
            font-weight: 600;
        }
        .test-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .test-info h3 {
            margin-top: 0;
            color: #856404;
        }
        .test-info code {
            background-color: #fff;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ”’ INICIS ë¹Œë§ í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ</h1>
    
    <div class="test-info">
        <h3>ğŸ“Œ í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì •ë³´</h3>
        <p>ì¹´ë“œë²ˆí˜¸: <code>5570-0810-0489-0411</code></p>
        <p>ìœ íš¨ê¸°ê°„: ë¯¸ë˜ ë‚ ì§œ (ì˜ˆ: 12/25)</p>
        <p>CVC: ì•„ë¬´ 3ìë¦¬ ìˆ«ì</p>
        <p>ë¹„ë°€ë²ˆí˜¸: ì¹´ë“œ ì• 2ìë¦¬</p>
    </div>
    
    <div class="container">
        <!-- Step 1: ë¹Œë§í‚¤ ë°œê¸‰ -->
        <div class="section">
            <h2>ğŸ“ Step 1: ë¹Œë§í‚¤ ë°œê¸‰ (ì¹´ë“œ ë“±ë¡)</h2>
            <form id="userInfoForm">
                <div class="form-group">
                    <label for="buyername">êµ¬ë§¤ì ì´ë¦„:</label>
                    <input type="text" id="buyername" value="í…ŒìŠ¤íŠ¸ìœ ì €" required>
                </div>
                <div class="form-group">
                    <label for="buyertel">ì „í™”ë²ˆí˜¸:</label>
                    <input type="tel" id="buyertel" value="01012341234" required>
                </div>
                <div class="form-group">
                    <label for="buyeremail">ì´ë©”ì¼:</label>
                    <input type="email" id="buyeremail" value="test@example.com" required>
                </div>
                <div class="form-group">
                    <label for="goodname">ìƒí’ˆëª…:</label>
                    <input type="text" id="goodname" value="ì •ê¸°ê²°ì œ ì„œë¹„ìŠ¤" required>
                </div>
            </form>
            <button onclick="requestBillingKey()">ğŸš€ ë¹Œë§í‚¤ ë°œê¸‰í•˜ê¸°</button>
            <div id="billingKeyResult" class="result" style="display:none;"></div>
        </div>

        <!-- Step 2: ì €ì¥ëœ ë¹Œë§í‚¤ ì •ë³´ -->
        <div class="section">
            <h2>ğŸ’³ Step 2: ì €ì¥ëœ ë¹Œë§í‚¤ ì •ë³´</h2>
            <div id="savedBillingKey" class="billing-key-info">
                <p class="info">ë¹Œë§í‚¤ê°€ ì•„ì§ ë°œê¸‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                <p>ìœ„ì—ì„œ ì¹´ë“œë¥¼ ë“±ë¡í•˜ì—¬ ë¹Œë§í‚¤ë¥¼ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.</p>
            </div>
        </div>

        <!-- Step 3: ë¹Œë§ ìŠ¹ì¸ (ì •ê¸°ê²°ì œ) -->
        <div class="section">
            <h2>ğŸ’° Step 3: ë¹Œë§ ìŠ¹ì¸ (ì •ê¸°ê²°ì œ í…ŒìŠ¤íŠ¸)</h2>
            <form id="billingForm">
                <div class="form-group">
                    <label for="price">ê²°ì œ ê¸ˆì•¡ (ì›):</label>
                    <input type="number" id="price" value="1000" min="1000" required>
                </div>
                <div class="form-group">
                    <label for="billGoodname">ê²°ì œ ìƒí’ˆëª…:</label>
                    <input type="text" id="billGoodname" value="ì›” ì •ê¸°ê²°ì œ" required>
                </div>
            </form>
            <button onclick="processBilling(1)" id="billingBtn1" disabled>ğŸ’³ 1ì°¨ ê²°ì œ ì‹¤í–‰</button>
            <button onclick="processBilling(2)" id="billingBtn2" disabled>ğŸ’³ 2ì°¨ ê²°ì œ ì‹¤í–‰</button>
            <button onclick="clearResults()" style="background-color: #666;">ğŸ—‘ï¸ ê²°ê³¼ ì´ˆê¸°í™”</button>
            <div id="billingResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <!-- Hidden form for billing key registration -->
    <form id="SendPayForm_id" name="SendPayForm_id" method="POST" style="display:none;">
        <input type="hidden" name="version" value="1.0">
        <input type="hidden" name="mid" value="INIBillTst">
        <input type="hidden" name="oid" value="">
        <input type="hidden" name="price" value="0">
        <input type="hidden" name="timestamp" value="">
        <input type="hidden" name="signature" value="">
        <input type="hidden" name="mKey" value="">
        <input type="hidden" name="currency" value="WON">
        <input type="hidden" name="goodname" value="">
        <input type="hidden" name="buyername" value="">
        <input type="hidden" name="buyertel" value="">
        <input type="hidden" name="buyeremail" value="">
        <input type="hidden" name="returnUrl" value="">
        <input type="hidden" name="closeUrl" value="">
        <input type="hidden" name="gopaymethod" value="Card">
        <input type="hidden" name="acceptmethod" value="below1000:BILLAUTH(Card)">
        <input type="hidden" name="charset" value="UTF-8">
        <input type="hidden" name="nointerest" value="">
        <input type="hidden" name="quotabase" value="">
        <input type="hidden" name="languageView" value="ko">
        <input type="hidden" name="payViewType" value="overlay">
        <input type="hidden" name="merchantData" value="">
    </form>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë¡œ ë¹Œë§í‚¤ ì €ì¥
        let savedBillKey = null;
        let savedCardInfo = null;

        // SHA256 í•´ì‹œ í•¨ìˆ˜
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // YYYYMMDDHHMMSS í˜•ì‹ì˜ timestamp ìƒì„±
        function getFormattedTimestamp() {
            const now = new Date();
            const pad = (n, length) => {
                let str = '' + n;
                while (str.length < length) {
                    str = '0' + str;
                }
                return str;
            };
            
            const yyyy = now.getFullYear().toString();
            const MM = pad(now.getMonth() + 1, 2);
            const dd = pad(now.getDate(), 2);
            const hh = pad(now.getHours(), 2);
            const mm = pad(now.getMinutes(), 2);
            const ss = pad(now.getSeconds(), 2);
            
            return yyyy + MM + dd + hh + mm + ss;
        }

        // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<span class="${isError ? 'error' : 'success'}">${new Date().toLocaleTimeString()}</span> - ${message}`;
        }

        // Step 1: ë¹Œë§í‚¤ ë°œê¸‰
        async function requestBillingKey() {
            const timestamp = Date.now().toString();
            const formattedTimestamp = getFormattedTimestamp();
            const oid = "BILL_" + formattedTimestamp + "_TEST";
            const price = "0"; // ë¹Œë§í‚¤ ë°œê¸‰ì€ 0ì›
            
            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const buyername = document.getElementById('buyername').value;
            const buyertel = document.getElementById('buyertel').value;
            const buyeremail = document.getElementById('buyeremail').value;
            const goodname = document.getElementById('goodname').value;
            
            // í¼ ê°’ ì„¤ì •
            document.getElementsByName("oid")[0].value = oid;
            document.getElementsByName("timestamp")[0].value = timestamp;
            document.getElementsByName("goodname")[0].value = goodname;
            document.getElementsByName("buyername")[0].value = buyername;
            document.getElementsByName("buyertel")[0].value = buyertel;
            document.getElementsByName("buyeremail")[0].value = buyeremail;
            
            // URL ì„¤ì •
            const baseUrl = window.location.origin;
            document.getElementsByName("returnUrl")[0].value = baseUrl + "/billing-return";
            document.getElementsByName("closeUrl")[0].value = baseUrl + "/close.html";
            
            // merchantData ì„¤ì •
            const merchantData = {
                userId: "test_user_" + Date.now(),
                type: "billing_key_registration"
            };
            document.getElementsByName("merchantData")[0].value = JSON.stringify(merchantData);
            
            // mKey ìƒì„±
            const signKey = "SU5JTElURV9UUklQTEVERVNfS0VZU1RS";
            const mKey = await sha256(signKey);
            document.getElementsByName("mKey")[0].value = mKey;
            
            // signature ìƒì„±
            const signatureData = "oid=" + oid + "&price=" + price + "&timestamp=" + timestamp;
            const signature = await sha256(signatureData);
            document.getElementsByName("signature")[0].value = signature;
            
            console.log("Form data:", {
                oid: oid,
                timestamp: timestamp,
                mKey: mKey,
                signature: signature,
                payViewType: document.getElementsByName("payViewType")[0].value
            });
            
            showResult('billingKeyResult', 'ë¹Œë§í‚¤ ë°œê¸‰ ìš”ì²­ ì¤‘... INICIS ê²°ì œì°½ì´ ì—´ë¦½ë‹ˆë‹¤.');
            
            // INICIS ê²°ì œì°½ í˜¸ì¶œ
            try {
                console.log("Calling INIStdPay.pay...");
                INIStdPay.pay('SendPayForm_id');
                console.log("INIStdPay.pay called successfully");
            } catch (e) {
                console.error("INICIS Error:", e);
                showResult('billingKeyResult', 'ì˜¤ë¥˜: ' + e.message, true);
            }
        }

        // ë¹Œë§í‚¤ ì„¤ì • (í…ŒìŠ¤íŠ¸ìš©)
        function setBillingKeyManually() {
            const testKey = prompt("í…ŒìŠ¤íŠ¸ìš© ë¹Œë§í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: CARD_1234567890):");
            if (testKey) {
                saveBillingKey({
                    billKey: testKey,
                    cardInfo: "í…ŒìŠ¤íŠ¸ì¹´ë“œ ****-****-****-1234",
                    expireDate: "2025-12"
                });
            }
        }

        // ë¹Œë§í‚¤ ì €ì¥
        function saveBillingKey(billingInfo) {
            savedBillKey = billingInfo.billKey;
            savedCardInfo = billingInfo;
            
            localStorage.setItem('test_billing_key', JSON.stringify(billingInfo));
            
            document.getElementById('savedBillingKey').innerHTML = `
                <p class="success">âœ… ë¹Œë§í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                <p><strong>ë¹Œë§í‚¤:</strong> ${billingInfo.billKey}</p>
                <p><strong>ì¹´ë“œì •ë³´:</strong> ${billingInfo.cardInfo || 'ì¹´ë“œì •ë³´'}</p>
                <p><strong>ì €ì¥ì‹œê°„:</strong> ${new Date().toLocaleString()}</p>
                <button onclick="clearBillingKey()" style="background-color: #f44336;">ë¹Œë§í‚¤ ì‚­ì œ</button>
                <button onclick="setBillingKeyManually()" style="background-color: #ff9800;">í…ŒìŠ¤íŠ¸ ë¹Œë§í‚¤ ì„¤ì •</button>
            `;
            
            document.getElementById('billingBtn1').disabled = false;
            document.getElementById('billingBtn2').disabled = false;
            
            showResult('billingKeyResult', 'ë¹Œë§í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ë¹Œë§í‚¤ ì‚­ì œ
        function clearBillingKey() {
            if (confirm('ì €ì¥ëœ ë¹Œë§í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('test_billing_key');
                savedBillKey = null;
                savedCardInfo = null;
                location.reload();
            }
        }

        // ê²°ê³¼ ì´ˆê¸°í™”
        function clearResults() {
            document.getElementById('billingResult').innerHTML = '';
            document.getElementById('billingResult').style.display = 'none';
        }

        // Step 3: ë¹Œë§ ìŠ¹ì¸ (ì •ê¸°ê²°ì œ)
        async function processBilling(count) {
            if (!savedBillKey) {
                alert("ë¨¼ì € ë¹Œë§í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ì£¼ì„¸ìš”.");
                return;
            }
            
            const price = document.getElementById('price').value;
            const goodname = document.getElementById('billGoodname').value;
            const timestamp = getFormattedTimestamp();
            const moid = "PAY_" + timestamp + "_" + count;
            
            const resultDiv = document.getElementById('billingResult');
            resultDiv.style.display = 'block';
            
            resultDiv.innerHTML += `\n========== ${count}ì°¨ ê²°ì œ ì‹œë„ ==========\n`;
            resultDiv.innerHTML += `ì£¼ë¬¸ë²ˆí˜¸: ${moid}\n`;
            resultDiv.innerHTML += `ê²°ì œê¸ˆì•¡: ${price}ì›\n`;
            resultDiv.innerHTML += `ë¹Œë§í‚¤: ${savedBillKey}\n`;
            resultDiv.innerHTML += `ìš”ì²­ì‹œê°„: ${new Date().toLocaleString()}\n`;
            
            try {
                // ì„œë²„ API í˜¸ì¶œ
                const response = await fetch('/api/billing/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        moid: moid,
                        price: price,
                        billKey: savedBillKey,
                        goodName: goodname,
                        buyerName: document.getElementById('buyername').value,
                        buyerEmail: document.getElementById('buyeremail').value,
                        buyerTel: document.getElementById('buyertel').value
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML += `<span class="success">âœ… ê²°ì œ ì„±ê³µ!</span>\n`;
                    resultDiv.innerHTML += `ìŠ¹ì¸ë²ˆí˜¸: ${result.tid}\n`;
                    resultDiv.innerHTML += `ìŠ¹ì¸ì‹œê°„: ${result.authDate} ${result.authTime}\n`;
                } else {
                    resultDiv.innerHTML += `<span class="error">âŒ ê²°ì œ ì‹¤íŒ¨</span>\n`;
                    resultDiv.innerHTML += `ì˜¤ë¥˜: ${result.message}\n`;
                }
            } catch (error) {
                resultDiv.innerHTML += `<span class="error">âŒ API í˜¸ì¶œ ì‹¤íŒ¨</span>\n`;
                resultDiv.innerHTML += `ì˜¤ë¥˜: ${error.message}\n`;
                resultDiv.innerHTML += `\nğŸ’¡ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.\n`;
            }
            
            resultDiv.innerHTML += `=====================================\n\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¹Œë§í‚¤ í™•ì¸
            const savedBilling = localStorage.getItem('test_billing_key');
            if (savedBilling) {
                const billingInfo = JSON.parse(savedBilling);
                saveBillingKey(billingInfo);
            } else {
                document.getElementById('savedBillingKey').innerHTML += `
                    <br><button onclick="setBillingKeyManually()" style="background-color: #ff9800; margin-top: 10px;">
                        ğŸ”§ í…ŒìŠ¤íŠ¸ìš© ë¹Œë§í‚¤ ìˆ˜ë™ ì„¤ì •
                    </button>
                `;
            }
        };

        // ë©”ì‹œì§€ ìˆ˜ì‹  (íŒì—…ì—ì„œ ê²°ê³¼ ë°›ê¸°)
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'billing_key_result') {
                const params = event.data.params;
                if (params.resultCode === '0000' && params.billKey) {
                    saveBillingKey({
                        billKey: params.billKey,
                        cardInfo: params.cardInfo || 'ì¹´ë“œì •ë³´',
                        orderNumber: params.orderNumber
                    });
                }
            }
        });
    </script>
</body>
</html>