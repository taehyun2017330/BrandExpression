<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>INICIS 빌링 테스트 - Standalone</title>
    <script type="text/javascript" src="https://stgstdpay.inicis.com/stdjs/INIStdPay.js" charset="UTF-8"></script>
    <script>
        // Check if INICIS script loaded
        window.addEventListener('load', function() {
            if (typeof INIStdPay === 'undefined') {
                alert('INICIS 스크립트를 로드하지 못했습니다. 페이지를 새로고침해주세요.');
            } else {
                console.log('INICIS script loaded successfully');
            }
        });
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        input[type="text"], input[type="email"], input[type="tel"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus {
            outline: none;
            border-color: #4CAF50;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            background-color: #f9f9f9;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .billing-key-info {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #90caf9;
        }
        .success {
            color: #2e7d32;
            font-weight: 600;
        }
        .error {
            color: #d32f2f;
            font-weight: 600;
        }
        .info {
            color: #1976d2;
            font-weight: 600;
        }
        .test-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .test-info h3 {
            margin-top: 0;
            color: #856404;
        }
        .test-info code {
            background-color: #fff;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>🔒 INICIS 빌링 테스트 시스템</h1>
    
    <div class="test-info">
        <h3>📌 테스트 카드 정보</h3>
        <p>카드번호: <code>5570-0810-0489-0411</code></p>
        <p>유효기간: 미래 날짜 (예: 12/25)</p>
        <p>CVC: 아무 3자리 숫자</p>
        <p>비밀번호: 카드 앞 2자리</p>
    </div>
    
    <div class="container">
        <!-- Step 1: 빌링키 발급 -->
        <div class="section">
            <h2>📝 Step 1: 빌링키 발급 (카드 등록)</h2>
            <form id="userInfoForm">
                <div class="form-group">
                    <label for="buyername">구매자 이름:</label>
                    <input type="text" id="buyername" value="테스트유저" required>
                </div>
                <div class="form-group">
                    <label for="buyertel">전화번호:</label>
                    <input type="tel" id="buyertel" value="01012341234" required>
                </div>
                <div class="form-group">
                    <label for="buyeremail">이메일:</label>
                    <input type="email" id="buyeremail" value="test@example.com" required>
                </div>
                <div class="form-group">
                    <label for="goodname">상품명:</label>
                    <input type="text" id="goodname" value="정기결제 서비스" required>
                </div>
            </form>
            <button onclick="requestBillingKey()">🚀 빌링키 발급하기</button>
            <div id="billingKeyResult" class="result" style="display:none;"></div>
        </div>

        <!-- Step 2: 저장된 빌링키 정보 -->
        <div class="section">
            <h2>💳 Step 2: 저장된 빌링키 정보</h2>
            <div id="savedBillingKey" class="billing-key-info">
                <p class="info">빌링키가 아직 발급되지 않았습니다.</p>
                <p>위에서 카드를 등록하여 빌링키를 발급받으세요.</p>
            </div>
        </div>

        <!-- Step 3: 빌링 승인 (정기결제) -->
        <div class="section">
            <h2>💰 Step 3: 빌링 승인 (정기결제 테스트)</h2>
            <form id="billingForm">
                <div class="form-group">
                    <label for="price">결제 금액 (원):</label>
                    <input type="number" id="price" value="1000" min="1000" required>
                </div>
                <div class="form-group">
                    <label for="billGoodname">결제 상품명:</label>
                    <input type="text" id="billGoodname" value="월 정기결제" required>
                </div>
            </form>
            <button onclick="processBilling(1)" id="billingBtn1" disabled>💳 1차 결제 실행</button>
            <button onclick="processBilling(2)" id="billingBtn2" disabled>💳 2차 결제 실행</button>
            <button onclick="clearResults()" style="background-color: #666;">🗑️ 결과 초기화</button>
            <div id="billingResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <!-- Hidden form for billing key registration -->
    <form id="SendPayForm_id" name="SendPayForm_id" method="POST" style="display:none;">
        <input type="hidden" name="version" value="1.0">
        <input type="hidden" name="mid" value="INIBillTst">
        <input type="hidden" name="oid" value="">
        <input type="hidden" name="price" value="0">
        <input type="hidden" name="timestamp" value="">
        <input type="hidden" name="signature" value="">
        <input type="hidden" name="mKey" value="">
        <input type="hidden" name="currency" value="WON">
        <input type="hidden" name="goodname" value="">
        <input type="hidden" name="buyername" value="">
        <input type="hidden" name="buyertel" value="">
        <input type="hidden" name="buyeremail" value="">
        <input type="hidden" name="returnUrl" value="">
        <input type="hidden" name="closeUrl" value="">
        <input type="hidden" name="gopaymethod" value="Card">
        <input type="hidden" name="acceptmethod" value="below1000:BILLAUTH(Card)">
        <input type="hidden" name="charset" value="UTF-8">
        <input type="hidden" name="nointerest" value="">
        <input type="hidden" name="quotabase" value="">
        <input type="hidden" name="languageView" value="ko">
        <input type="hidden" name="payViewType" value="overlay">
        <input type="hidden" name="merchantData" value="">
    </form>

    <script>
        // 전역 변수로 빌링키 저장
        let savedBillKey = null;
        let savedCardInfo = null;

        // SHA256 해시 함수
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // YYYYMMDDHHMMSS 형식의 timestamp 생성
        function getFormattedTimestamp() {
            const now = new Date();
            const pad = (n, length) => {
                let str = '' + n;
                while (str.length < length) {
                    str = '0' + str;
                }
                return str;
            };
            
            const yyyy = now.getFullYear().toString();
            const MM = pad(now.getMonth() + 1, 2);
            const dd = pad(now.getDate(), 2);
            const hh = pad(now.getHours(), 2);
            const mm = pad(now.getMinutes(), 2);
            const ss = pad(now.getSeconds(), 2);
            
            return yyyy + MM + dd + hh + mm + ss;
        }

        // 결과 표시 함수
        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<span class="${isError ? 'error' : 'success'}">${new Date().toLocaleTimeString()}</span> - ${message}`;
        }

        // Step 1: 빌링키 발급
        async function requestBillingKey() {
            const timestamp = Date.now().toString();
            const formattedTimestamp = getFormattedTimestamp();
            const oid = "BILL_" + formattedTimestamp + "_TEST";
            const price = "0"; // 빌링키 발급은 0원
            
            // 사용자 정보 가져오기
            const buyername = document.getElementById('buyername').value;
            const buyertel = document.getElementById('buyertel').value;
            const buyeremail = document.getElementById('buyeremail').value;
            const goodname = document.getElementById('goodname').value;
            
            // 폼 값 설정
            document.getElementsByName("oid")[0].value = oid;
            document.getElementsByName("timestamp")[0].value = timestamp;
            document.getElementsByName("goodname")[0].value = goodname;
            document.getElementsByName("buyername")[0].value = buyername;
            document.getElementsByName("buyertel")[0].value = buyertel;
            document.getElementsByName("buyeremail")[0].value = buyeremail;
            
            // URL 설정
            const baseUrl = window.location.origin;
            document.getElementsByName("returnUrl")[0].value = baseUrl + "/billing-return";
            document.getElementsByName("closeUrl")[0].value = baseUrl + "/close.html";
            
            // merchantData 설정
            const merchantData = {
                userId: "test_user_" + Date.now(),
                type: "billing_key_registration"
            };
            document.getElementsByName("merchantData")[0].value = JSON.stringify(merchantData);
            
            // mKey 생성
            const signKey = "SU5JTElURV9UUklQTEVERVNfS0VZU1RS";
            const mKey = await sha256(signKey);
            document.getElementsByName("mKey")[0].value = mKey;
            
            // signature 생성
            const signatureData = "oid=" + oid + "&price=" + price + "&timestamp=" + timestamp;
            const signature = await sha256(signatureData);
            document.getElementsByName("signature")[0].value = signature;
            
            console.log("Form data:", {
                oid: oid,
                timestamp: timestamp,
                mKey: mKey,
                signature: signature,
                payViewType: document.getElementsByName("payViewType")[0].value
            });
            
            showResult('billingKeyResult', '빌링키 발급 요청 중... INICIS 결제창이 열립니다.');
            
            // INICIS 결제창 호출
            try {
                console.log("Calling INIStdPay.pay...");
                INIStdPay.pay('SendPayForm_id');
                console.log("INIStdPay.pay called successfully");
            } catch (e) {
                console.error("INICIS Error:", e);
                showResult('billingKeyResult', '오류: ' + e.message, true);
            }
        }

        // 빌링키 설정 (테스트용)
        function setBillingKeyManually() {
            const testKey = prompt("테스트용 빌링키를 입력하세요 (예: CARD_1234567890):");
            if (testKey) {
                saveBillingKey({
                    billKey: testKey,
                    cardInfo: "테스트카드 ****-****-****-1234",
                    expireDate: "2025-12"
                });
            }
        }

        // 빌링키 저장
        function saveBillingKey(billingInfo) {
            savedBillKey = billingInfo.billKey;
            savedCardInfo = billingInfo;
            
            localStorage.setItem('test_billing_key', JSON.stringify(billingInfo));
            
            document.getElementById('savedBillingKey').innerHTML = `
                <p class="success">✅ 빌링키가 저장되었습니다!</p>
                <p><strong>빌링키:</strong> ${billingInfo.billKey}</p>
                <p><strong>카드정보:</strong> ${billingInfo.cardInfo || '카드정보'}</p>
                <p><strong>저장시간:</strong> ${new Date().toLocaleString()}</p>
                <button onclick="clearBillingKey()" style="background-color: #f44336;">빌링키 삭제</button>
                <button onclick="setBillingKeyManually()" style="background-color: #ff9800;">테스트 빌링키 설정</button>
            `;
            
            document.getElementById('billingBtn1').disabled = false;
            document.getElementById('billingBtn2').disabled = false;
            
            showResult('billingKeyResult', '빌링키가 성공적으로 저장되었습니다!');
        }

        // 빌링키 삭제
        function clearBillingKey() {
            if (confirm('저장된 빌링키를 삭제하시겠습니까?')) {
                localStorage.removeItem('test_billing_key');
                savedBillKey = null;
                savedCardInfo = null;
                location.reload();
            }
        }

        // 결과 초기화
        function clearResults() {
            document.getElementById('billingResult').innerHTML = '';
            document.getElementById('billingResult').style.display = 'none';
        }

        // Step 3: 빌링 승인 (정기결제)
        async function processBilling(count) {
            if (!savedBillKey) {
                alert("먼저 빌링키를 발급받아주세요.");
                return;
            }
            
            const price = document.getElementById('price').value;
            const goodname = document.getElementById('billGoodname').value;
            const timestamp = getFormattedTimestamp();
            const moid = "PAY_" + timestamp + "_" + count;
            
            const resultDiv = document.getElementById('billingResult');
            resultDiv.style.display = 'block';
            
            resultDiv.innerHTML += `\n========== ${count}차 결제 시도 ==========\n`;
            resultDiv.innerHTML += `주문번호: ${moid}\n`;
            resultDiv.innerHTML += `결제금액: ${price}원\n`;
            resultDiv.innerHTML += `빌링키: ${savedBillKey}\n`;
            resultDiv.innerHTML += `요청시간: ${new Date().toLocaleString()}\n`;
            
            try {
                // 서버 API 호출
                const response = await fetch('/api/billing/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        moid: moid,
                        price: price,
                        billKey: savedBillKey,
                        goodName: goodname,
                        buyerName: document.getElementById('buyername').value,
                        buyerEmail: document.getElementById('buyeremail').value,
                        buyerTel: document.getElementById('buyertel').value
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML += `<span class="success">✅ 결제 성공!</span>\n`;
                    resultDiv.innerHTML += `승인번호: ${result.tid}\n`;
                    resultDiv.innerHTML += `승인시간: ${result.authDate} ${result.authTime}\n`;
                } else {
                    resultDiv.innerHTML += `<span class="error">❌ 결제 실패</span>\n`;
                    resultDiv.innerHTML += `오류: ${result.message}\n`;
                }
            } catch (error) {
                resultDiv.innerHTML += `<span class="error">❌ API 호출 실패</span>\n`;
                resultDiv.innerHTML += `오류: ${error.message}\n`;
                resultDiv.innerHTML += `\n💡 서버가 실행 중인지 확인하세요.\n`;
            }
            
            resultDiv.innerHTML += `=====================================\n\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            // 로컬 스토리지에서 빌링키 확인
            const savedBilling = localStorage.getItem('test_billing_key');
            if (savedBilling) {
                const billingInfo = JSON.parse(savedBilling);
                saveBillingKey(billingInfo);
            } else {
                document.getElementById('savedBillingKey').innerHTML += `
                    <br><button onclick="setBillingKeyManually()" style="background-color: #ff9800; margin-top: 10px;">
                        🔧 테스트용 빌링키 수동 설정
                    </button>
                `;
            }
        };

        // 메시지 수신 (팝업에서 결과 받기)
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'billing_key_result') {
                const params = event.data.params;
                if (params.resultCode === '0000' && params.billKey) {
                    saveBillingKey({
                        billKey: params.billKey,
                        cardInfo: params.cardInfo || '카드정보',
                        orderNumber: params.orderNumber
                    });
                }
            }
        });
    </script>
</body>
</html>