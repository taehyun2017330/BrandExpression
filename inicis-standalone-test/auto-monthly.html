<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Auto Monthly Payment System</title>
    <script type="text/javascript" src="https://stgstdpay.inicis.com/stdjs/INIStdPay.js" charset="UTF-8"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: #333; }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .card-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .payment-history {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .payment-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .payment-item.success { border-left: 4px solid #4CAF50; }
        .payment-item.pending { border-left: 4px solid #ff9800; }
        .payment-item.failed { border-left: 4px solid #f44336; }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Auto Monthly Payment System</h1>
        
        <div class="warning">
            <h3>‚ö†Ô∏è Real Recurring Payment Simulation</h3>
            <p>Payment 1: Opens INICIS window (100Ïõê)</p>
            <p>Payments 2 & 3: Automatically charges using saved card info (no window)</p>
        </div>
        
        <!-- Saved Card Info -->
        <div class="section">
            <h2>Saved Card Information</h2>
            <div id="noCard">
                <p>No card saved. Click below to register a card.</p>
                <button onclick="registerNewCard()">Register New Card (100Ïõê)</button>
            </div>
            <div id="savedCard" class="card-info" style="display:none;">
                <h3>‚úÖ Card on File</h3>
                <p><strong>Card:</strong> <span id="cardName"></span> <span id="cardNum"></span></p>
                <p><strong>TID:</strong> <span id="tid"></span></p>
                <p><strong>Registered:</strong> <span id="regDate"></span></p>
                <button onclick="clearCard()" style="background-color: #f44336;">Remove Card</button>
            </div>
        </div>
        
        <!-- Monthly Payments -->
        <div id="paymentSection" class="section" style="display:none;">
            <h2>Monthly Payment Controls</h2>
            <p>Click buttons to simulate monthly charges using your saved card:</p>
            
            <button id="payment2Btn" onclick="processAutoPayment(2)">
                Process 2nd Monthly Payment (100Ïõê) - Auto
            </button>
            
            <button id="payment3Btn" onclick="processAutoPayment(3)" style="display:none;">
                Process 3rd Monthly Payment (100Ïõê) - Auto
            </button>
        </div>
        
        <!-- Payment History -->
        <div class="section">
            <h2>Payment History</h2>
            <div class="payment-history">
                <div id="paymentHistory">
                    <p style="color: #999;">No payments yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form for initial registration only -->
    <form id="payForm" method="POST" style="display:none;">
        <input type="hidden" name="version" value="1.0">
        <input type="hidden" name="gopaymethod" value="">
        <input type="hidden" name="mid" value="INIBillTst">
        <input type="hidden" name="oid" value="">
        <input type="hidden" name="price" value="100">
        <input type="hidden" name="timestamp" value="">
        <input type="hidden" name="signature" value="">
        <input type="hidden" name="mKey" value="">
        <input type="hidden" name="currency" value="WON">
        <input type="hidden" name="goodname" value="Ïπ¥ÎìúÎì±Î°ù">
        <input type="hidden" name="buyername" value="ÌÖåÏä§ÌÑ∞">
        <input type="hidden" name="buyertel" value="01012345678">
        <input type="hidden" name="buyeremail" value="test@test.com">
        <input type="hidden" name="returnUrl" value="http://localhost:3000/auto-return">
        <input type="hidden" name="closeUrl" value="http://localhost:3000/close.html">
        <input type="hidden" name="acceptmethod" value="HPP(1):below1000:cardautostore">
        <input type="hidden" name="charset" value="UTF-8">
        <input type="hidden" name="languageView" value="ko">
        <input type="hidden" name="payViewType" value="overlay">
    </form>

    <script>
        let savedCard = null;
        let paymentHistory = [];
        
        // Load saved data on startup
        window.onload = function() {
            loadSavedData();
        };
        
        function loadSavedData() {
            // Load card info
            const cardData = localStorage.getItem('auto_card_info');
            if (cardData) {
                savedCard = JSON.parse(cardData);
                showSavedCard();
            }
            
            // Load payment history
            const historyData = localStorage.getItem('auto_payment_history');
            if (historyData) {
                paymentHistory = JSON.parse(historyData);
                updateHistoryDisplay();
            }
        }
        
        function showSavedCard() {
            if (savedCard) {
                document.getElementById('noCard').style.display = 'none';
                document.getElementById('savedCard').style.display = 'block';
                document.getElementById('paymentSection').style.display = 'block';
                
                document.getElementById('cardName').textContent = savedCard.cardName || 'Ïπ¥Îìú';
                document.getElementById('cardNum').textContent = savedCard.cardNum || '****-****-****-****';
                document.getElementById('tid').textContent = savedCard.tid;
                document.getElementById('regDate').textContent = savedCard.regDate;
                
                // Show appropriate payment button
                const successCount = paymentHistory.filter(p => p.status === 'success').length;
                if (successCount >= 2) {
                    document.getElementById('payment3Btn').style.display = 'block';
                }
            }
        }
        
        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('paymentHistory');
            if (paymentHistory.length === 0) {
                historyDiv.innerHTML = '<p style="color: #999;">No payments yet.</p>';
            } else {
                historyDiv.innerHTML = paymentHistory.map(payment => `
                    <div class="payment-item ${payment.status}">
                        <strong>Payment ${payment.number}</strong> - ${payment.amount}Ïõê
                        <br>Status: ${payment.status.toUpperCase()}
                        <br>Time: ${payment.time}
                        <br>Method: ${payment.method}
                        ${payment.tid ? '<br>TID: ' + payment.tid : ''}
                        ${payment.message ? '<br>' + payment.message : ''}
                    </div>
                `).join('');
            }
        }
        
        function addPayment(payment) {
            paymentHistory.unshift(payment);
            localStorage.setItem('auto_payment_history', JSON.stringify(paymentHistory));
            updateHistoryDisplay();
        }
        
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        // Only for initial card registration
        async function registerNewCard() {
            const timestamp = Date.now().toString();
            const oid = "AUTO_REG_" + timestamp;
            
            // Set form values
            document.getElementsByName("oid")[0].value = oid;
            document.getElementsByName("timestamp")[0].value = timestamp;
            
            // Generate keys
            const signKey = "SU5JTElURV9UUklQTEVERVNfS0VZU1RS";
            const mKey = await sha256(signKey);
            document.getElementsByName("mKey")[0].value = mKey;
            
            // Generate signature
            const signatureData = `oid=${oid}&price=100&timestamp=${timestamp}`;
            const signature = await sha256(signatureData);
            document.getElementsByName("signature")[0].value = signature;
            
            localStorage.setItem('pending_reg', oid);
            
            try {
                INIStdPay.pay('payForm');
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        // Automatic payment using saved card (no INICIS window)
        async function processAutoPayment(paymentNumber) {
            if (!savedCard) {
                alert('No card on file. Please register a card first.');
                return;
            }
            
            const btn = document.getElementById(`payment${paymentNumber}Btn`);
            btn.disabled = true;
            btn.innerHTML = `Processing Payment ${paymentNumber}... <div class="loading" style="display: inline-block;"></div>`;
            
            // Add pending payment
            const pendingPayment = {
                number: paymentNumber,
                amount: 100,
                status: 'pending',
                time: new Date().toLocaleString(),
                method: 'Automatic (Saved Card)',
                message: 'Processing automatic payment...'
            };
            addPayment(pendingPayment);
            
            // Simulate API call to charge saved card
            try {
                const response = await fetch('/api/auto-charge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        savedTid: savedCard.tid,
                        amount: 100,
                        paymentNumber: paymentNumber,
                        cardInfo: savedCard
                    })
                });
                
                const result = await response.json();
                
                // Update payment status
                paymentHistory[0] = {
                    number: paymentNumber,
                    amount: 100,
                    status: 'success',
                    time: new Date().toLocaleString(),
                    method: 'Automatic (Saved Card)',
                    tid: result.tid || `AUTO_${paymentNumber}_${Date.now()}`,
                    message: 'Automatic payment successful - 100Ïõê charged'
                };
                
                localStorage.setItem('auto_payment_history', JSON.stringify(paymentHistory));
                updateHistoryDisplay();
                
                btn.innerHTML = `Payment ${paymentNumber} Complete ‚úì`;
                alert(`Payment ${paymentNumber} successful!\n\n` +
                      `üí≥ 100Ïõê automatically charged to saved card\n` +
                      `üîÑ No payment window needed!\n` +
                      `‚è∞ Will be cancelled at midnight`);
                
                // Show next button
                if (paymentNumber === 2) {
                    document.getElementById('payment3Btn').style.display = 'block';
                }
                
            } catch (error) {
                // Update payment as failed
                paymentHistory[0].status = 'failed';
                paymentHistory[0].message = error.message;
                updateHistoryDisplay();
                
                btn.disabled = false;
                btn.innerHTML = `Retry Payment ${paymentNumber}`;
                alert('Payment failed: ' + error.message);
            }
        }
        
        function clearCard() {
            if (confirm('Remove saved card and clear all data?')) {
                localStorage.removeItem('auto_card_info');
                localStorage.removeItem('auto_payment_history');
                location.reload();
            }
        }
        
        // Handle payment registration result
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'auto_payment_complete') {
                const result = event.data.params;
                if (result.success) {
                    // Save card info
                    savedCard = {
                        tid: result.tid,
                        cardNum: result.cardNum || '****-****-****-****',
                        cardName: result.cardName || 'Ïπ¥Îìú',
                        regDate: new Date().toLocaleDateString()
                    };
                    localStorage.setItem('auto_card_info', JSON.stringify(savedCard));
                    
                    // Add first payment to history
                    addPayment({
                        number: 1,
                        amount: 100,
                        status: 'success',
                        time: new Date().toLocaleString(),
                        method: 'INICIS Payment Window',
                        tid: result.tid,
                        message: 'Card registered - 100Ïõê charged'
                    });
                    
                    showSavedCard();
                    localStorage.removeItem('pending_reg');
                    
                    alert('Card registered successfully!\n\n' +
                          '‚úÖ 100Ïõê charged (Payment 1)\n' +
                          'üí≥ Card saved for automatic payments\n' +
                          'üîÑ Payments 2 & 3 will be automatic!');
                }
            }
        });
    </script>
</body>
</html>