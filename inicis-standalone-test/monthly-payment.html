<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>INICIS ì›” ì •ê¸°ê²°ì œ ì‹œìŠ¤í…œ</title>
    <script type="text/javascript" src="https://stgstdpay.inicis.com/stdjs/INIStdPay.js" charset="UTF-8"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: #333; }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .card-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .payment-history {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .payment-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .danger {
            background-color: #f44336;
        }
        .danger:hover {
            background-color: #d32f2f;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.active { background: #4CAF50; color: white; }
        .status.pending { background: #ff9800; color: white; }
        .status.failed { background: #f44336; color: white; }
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’³ ì›” ì •ê¸°ê²°ì œ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        
        <!-- Step 1: ì¹´ë“œ ë“±ë¡ -->
        <div class="section">
            <h2>Step 1: ì¹´ë“œ ë“±ë¡ (ì¹´ë“œ ìë™ì €ì¥)</h2>
            <p>ë¨¼ì € ì •ê¸°ê²°ì œì— ì‚¬ìš©í•  ì¹´ë“œë¥¼ ë“±ë¡í•©ë‹ˆë‹¤. ì¹´ë“œ ì •ë³´ê°€ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
            
            <div class="form-group">
                <label>êµ¬ë… ìƒí’ˆ:</label>
                <select id="productSelect">
                    <option value="basic">Basic - ì›” 9,900ì›</option>
                    <option value="pro">Pro - ì›” 19,900ì›</option>
                    <option value="premium">Premium - ì›” 39,900ì›</option>
                </select>
            </div>
            
            <button onclick="registerCard()">ì¹´ë“œ ë“±ë¡í•˜ê¸°</button>
            
            <div id="savedCard" class="card-info" style="display:none;">
                <h3>ë“±ë¡ëœ ì¹´ë“œ ì •ë³´</h3>
                <p><strong>ì¹´ë“œë²ˆí˜¸:</strong> <span id="cardNumber"></span></p>
                <p><strong>ë“±ë¡ì¼:</strong> <span id="regDate"></span></p>
                <p><strong>TID:</strong> <span id="savedTid"></span></p>
                <button onclick="deleteCard()" class="danger">ì¹´ë“œ ì‚­ì œ</button>
            </div>
        </div>

        <!-- Step 2: êµ¬ë… ê´€ë¦¬ -->
        <div class="section">
            <h2>Step 2: êµ¬ë… ê´€ë¦¬</h2>
            <div id="subscriptionInfo" style="display:none;">
                <p><strong>êµ¬ë… ìƒíƒœ:</strong> <span class="status active">í™œì„±</span></p>
                <p><strong>êµ¬ë… ìƒí’ˆ:</strong> <span id="subProduct"></span></p>
                <p><strong>ì›” ê²°ì œì•¡:</strong> <span id="monthlyAmount"></span>ì›</p>
                <p><strong>ë‹¤ìŒ ê²°ì œì¼:</strong> <span id="nextPaymentDate"></span></p>
                
                <button onclick="processMonthlyPayment()">ì§€ê¸ˆ ê²°ì œí•˜ê¸°</button>
                <button onclick="pauseSubscription()">êµ¬ë… ì¼ì‹œì •ì§€</button>
                <button onclick="cancelSubscription()" class="danger">êµ¬ë… ì·¨ì†Œ</button>
            </div>
            
            <div id="noSubscription" style="display:block;">
                <p>ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¹´ë“œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.</p>
            </div>
        </div>

        <!-- Step 3: ê²°ì œ ë‚´ì—­ -->
        <div class="section">
            <h2>Step 3: ê²°ì œ ë‚´ì—­</h2>
            <div class="payment-history">
                <div id="paymentHistory">
                    <p style="color: #999;">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <!-- ìë™ ê²°ì œ ì‹œë®¬ë ˆì´ì…˜ -->
        <div class="section">
            <h2>ìë™ ê²°ì œ ì‹œë®¬ë ˆì´ì…˜</h2>
            <p>ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ í¬ë¡ ì¡ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>
            <button onclick="simulateMonthlyBatch()">ì›” ì •ê¸°ê²°ì œ ë°°ì¹˜ ì‹¤í–‰</button>
            <div id="batchResult" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- Payment Form -->
    <form id="payForm" method="POST" style="display:none;">
        <input type="hidden" name="version" value="1.0">
        <input type="hidden" name="gopaymethod" value="">
        <input type="hidden" name="mid" value="INIBillTst">
        <input type="hidden" name="oid" value="">
        <input type="hidden" name="price" value="100">
        <input type="hidden" name="timestamp" value="">
        <input type="hidden" name="signature" value="">
        <input type="hidden" name="mKey" value="">
        <input type="hidden" name="currency" value="WON">
        <input type="hidden" name="goodname" value="">
        <input type="hidden" name="buyername" value="í…ŒìŠ¤í„°">
        <input type="hidden" name="buyertel" value="01012345678">
        <input type="hidden" name="buyeremail" value="test@test.com">
        <input type="hidden" name="returnUrl" value="http://localhost:3000/subscription-return">
        <input type="hidden" name="closeUrl" value="http://localhost:3000/close.html">
        <input type="hidden" name="acceptmethod" value="HPP(1):below1000:cardautostore">
        <input type="hidden" name="charset" value="UTF-8">
        <input type="hidden" name="languageView" value="ko">
        <input type="hidden" name="payViewType" value="popup">
        <input type="hidden" name="popupUrl" value="http://localhost:3000/popup.html">
        <input type="hidden" name="merchantData" value="">
    </form>

    <script>
        // êµ¬ë… ì •ë³´ ì €ì¥
        let subscription = {
            cardInfo: null,
            product: null,
            status: 'inactive',
            nextPaymentDate: null,
            paymentHistory: []
        };

        // í˜ì´ì§€ ë¡œë“œì‹œ ì €ì¥ëœ ì •ë³´ ë³µì›
        window.onload = function() {
            const saved = localStorage.getItem('subscription_info');
            if (saved) {
                subscription = JSON.parse(saved);
                updateUI();
            }
        };

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            if (subscription.cardInfo) {
                // ì¹´ë“œ ì •ë³´ í‘œì‹œ
                document.getElementById('savedCard').style.display = 'block';
                document.getElementById('cardNumber').textContent = subscription.cardInfo.cardNum || '****-****-****-****';
                document.getElementById('regDate').textContent = subscription.cardInfo.regDate || new Date().toLocaleDateString();
                document.getElementById('savedTid').textContent = subscription.cardInfo.tid || 'N/A';
                
                // êµ¬ë… ì •ë³´ í‘œì‹œ
                document.getElementById('subscriptionInfo').style.display = 'block';
                document.getElementById('noSubscription').style.display = 'none';
                document.getElementById('subProduct').textContent = subscription.product?.name || 'Basic';
                document.getElementById('monthlyAmount').textContent = (subscription.product?.price || 9900).toLocaleString();
                document.getElementById('nextPaymentDate').textContent = subscription.nextPaymentDate || calculateNextPaymentDate();
            } else {
                document.getElementById('savedCard').style.display = 'none';
                document.getElementById('subscriptionInfo').style.display = 'none';
                document.getElementById('noSubscription').style.display = 'block';
            }
            
            // ê²°ì œ ë‚´ì—­ í‘œì‹œ
            updatePaymentHistory();
        }

        // ë‹¤ìŒ ê²°ì œì¼ ê³„ì‚°
        function calculateNextPaymentDate() {
            const date = new Date();
            date.setMonth(date.getMonth() + 1);
            return date.toLocaleDateString();
        }

        // ê²°ì œ ë‚´ì—­ ì—…ë°ì´íŠ¸
        function updatePaymentHistory() {
            const historyDiv = document.getElementById('paymentHistory');
            if (subscription.paymentHistory.length === 0) {
                historyDiv.innerHTML = '<p style="color: #999;">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                historyDiv.innerHTML = subscription.paymentHistory.map(payment => `
                    <div class="payment-item">
                        <span class="status ${payment.status}">${payment.status}</span>
                        <strong>${payment.date}</strong> - ${payment.amount}ì›
                        <br><small>${payment.message}</small>
                    </div>
                `).join('');
            }
        }

        // SHA256 í•´ì‹œ
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // ì¹´ë“œ ë“±ë¡
        async function registerCard() {
            const productSelect = document.getElementById('productSelect');
            const product = {
                type: productSelect.value,
                name: productSelect.value, // Use only English value, not Korean text
                price: productSelect.value === 'basic' ? 9900 : 
                       productSelect.value === 'pro' ? 19900 : 39900
            };
            
            const timestamp = Date.now().toString();
            const oid = "REG_" + timestamp;
            
            // Set form values
            document.getElementsByName("oid")[0].value = oid;
            document.getElementsByName("timestamp")[0].value = timestamp;
            document.getElementsByName("goodname")[0].value = product.name + " ì¹´ë“œë“±ë¡";
            document.getElementsByName("merchantData")[0].value = JSON.stringify({
                type: 'card_registration',
                product: product
            });
            
            // Generate keys
            const signKey = "SU5JTElURV9UUklQTEVERVNfS0VZU1RS";
            const mKey = await sha256(signKey);
            document.getElementsByName("mKey")[0].value = mKey;
            
            // Generate signature
            const signatureData = `oid=${oid}&price=100&timestamp=${timestamp}`;
            const signature = await sha256(signatureData);
            document.getElementsByName("signature")[0].value = signature;
            
            try {
                INIStdPay.pay('payForm');
            } catch (e) {
                alert('ì˜¤ë¥˜: ' + e.message);
            }
        }

        // ì›” ì •ê¸°ê²°ì œ ì²˜ë¦¬
        async function processMonthlyPayment() {
            if (!subscription.cardInfo) {
                alert('ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const payment = {
                date: new Date().toLocaleString(),
                amount: subscription.product.price,
                status: 'pending',
                message: 'ê²°ì œ ì²˜ë¦¬ ì¤‘...'
            };
            
            subscription.paymentHistory.unshift(payment);
            updatePaymentHistory();
            
            // ì‹¤ì œë¡œëŠ” ì„œë²„ APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì €ì¥ëœ ì¹´ë“œ ì •ë³´ë¡œ ê²°ì œ
            try {
                const response = await fetch('/api/subscription/charge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tid: subscription.cardInfo.tid,
                        amount: subscription.product.price,
                        product: subscription.product.name
                    })
                });
                
                if (response.ok) {
                    payment.status = 'active';
                    payment.message = 'ê²°ì œ ì™„ë£Œ';
                    
                    // ë‹¤ìŒ ê²°ì œì¼ ì—…ë°ì´íŠ¸
                    subscription.nextPaymentDate = calculateNextPaymentDate();
                } else {
                    payment.status = 'failed';
                    payment.message = 'ê²°ì œ ì‹¤íŒ¨';
                }
            } catch (error) {
                // ë°ëª¨ìš© - ì„±ê³µ ì‹œë®¬ë ˆì´ì…˜
                payment.status = 'active';
                payment.message = 'ê²°ì œ ì™„ë£Œ (ë°ëª¨)';
                subscription.nextPaymentDate = calculateNextPaymentDate();
            }
            
            saveSubscription();
            updateUI();
        }

        // ì›” ë°°ì¹˜ ì‹œë®¬ë ˆì´ì…˜
        async function simulateMonthlyBatch() {
            const resultDiv = document.getElementById('batchResult');
            resultDiv.innerHTML = '<p>ë°°ì¹˜ ì‘ì—… ì‹œì‘...</p>';
            
            // ì‹œë®¬ë ˆì´ì…˜: ë‹¤ìŒ ê²°ì œì¼ì´ ì˜¤ëŠ˜ì¸ ëª¨ë“  êµ¬ë… ì²˜ë¦¬
            if (subscription.cardInfo && subscription.status === 'active') {
                resultDiv.innerHTML += '<p>ì²˜ë¦¬ ëŒ€ìƒ: ' + subscription.product.name + '</p>';
                await processMonthlyPayment();
                resultDiv.innerHTML += '<p>âœ… ì²˜ë¦¬ ì™„ë£Œ</p>';
            } else {
                resultDiv.innerHTML += '<p>ì²˜ë¦¬ ëŒ€ìƒ ì—†ìŒ</p>';
            }
        }

        // êµ¬ë… ì¼ì‹œì •ì§€
        function pauseSubscription() {
            subscription.status = 'paused';
            saveSubscription();
            alert('êµ¬ë…ì´ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            updateUI();
        }

        // êµ¬ë… ì·¨ì†Œ
        function cancelSubscription() {
            if (confirm('ì •ë§ êµ¬ë…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                subscription.status = 'cancelled';
                subscription.cardInfo = null;
                saveSubscription();
                alert('êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                updateUI();
            }
        }

        // ì¹´ë“œ ì‚­ì œ
        function deleteCard() {
            if (confirm('ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? êµ¬ë…ë„ í•¨ê»˜ ì·¨ì†Œë©ë‹ˆë‹¤.')) {
                subscription.cardInfo = null;
                subscription.status = 'inactive';
                saveSubscription();
                updateUI();
            }
        }

        // êµ¬ë… ì •ë³´ ì €ì¥
        function saveSubscription() {
            localStorage.setItem('subscription_info', JSON.stringify(subscription));
        }

        // ê²°ì œ ê²°ê³¼ ìˆ˜ì‹ 
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'subscription_result') {
                const result = event.data.params;
                if (result.success) {
                    subscription.cardInfo = {
                        tid: result.tid,
                        cardNum: result.cardNum,
                        regDate: new Date().toLocaleDateString()
                    };
                    subscription.product = result.product;
                    subscription.status = 'active';
                    subscription.nextPaymentDate = calculateNextPaymentDate();
                    
                    // ì²« ê²°ì œ ê¸°ë¡
                    subscription.paymentHistory.unshift({
                        date: new Date().toLocaleString(),
                        amount: 100,
                        status: 'active',
                        message: 'ì¹´ë“œ ë“±ë¡ í™•ì¸ (100ì›)'
                    });
                    
                    saveSubscription();
                    updateUI();
                    
                    alert('ì¹´ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në‹¤ìŒ ê²°ì œì¼: ' + subscription.nextPaymentDate);
                }
            }
        });
    </script>
</body>
</html>