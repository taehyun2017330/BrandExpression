<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>INICIS ë¬´ì¸ì¦ì„œ ë¹Œë§í‚¤ ë°œê¸‰</title>
    <script type="text/javascript" src="https://stgstdpay.inicis.com/stdjs/INIStdPay.js" charset="UTF-8"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        button {
            background-color: #2196F3;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #1976D2;
        }
        .result {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>INICIS ë¬´ì¸ì¦ì„œ ë¹Œë§í‚¤ ë°œê¸‰</h1>
    
    <div class="info">
        <h3>ğŸ“Œ ì¸ì¦ì„œ ì—†ì´ ë¹Œë§í‚¤ ë°œê¸‰í•˜ê¸°</h3>
        <p>ì•„ë˜ ë°©ë²•ë“¤ì€ ê³µì¸ì¸ì¦ì„œê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:</p>
        <ul>
            <li>ISP ê²°ì œ (KBêµ­ë¯¼, ìš°ë¦¬, SCì œì¼ì€í–‰ ë“±)</li>
            <li>ì•ˆì‹¬í´ë¦­ (ê·¸ ì™¸ ì¹´ë“œì‚¬)</li>
            <li>ê°„í¸ê²°ì œ (ì¹´ì¹´ì˜¤í˜ì´, ë„¤ì´ë²„í˜ì´ ë“±)</li>
        </ul>
    </div>

    <h2>ë°©ë²• 1: ISP/ì•ˆì‹¬í´ë¦­ ìë™ì„ íƒ</h2>
    <button onclick="requestBilling('auto')">ìë™ì„ íƒ ë¹Œë§í‚¤ ë°œê¸‰</button>
    
    <h2>ë°©ë²• 2: ISP ê²°ì œ (KBêµ­ë¯¼, ìš°ë¦¬ì€í–‰ ì¹´ë“œ)</h2>
    <button onclick="requestBilling('isp')">ISP ë¹Œë§í‚¤ ë°œê¸‰</button>
    
    <h2>ë°©ë²• 3: ì•ˆì‹¬í´ë¦­ (ê·¸ ì™¸ ì¹´ë“œ)</h2>
    <button onclick="requestBilling('ansim')">ì•ˆì‹¬í´ë¦­ ë¹Œë§í‚¤ ë°œê¸‰</button>
    
    <h2>ë°©ë²• 4: ê°„í¸ê²°ì œ</h2>
    <button onclick="requestBilling('kakao')">ì¹´ì¹´ì˜¤í˜ì´</button>
    <button onclick="requestBilling('naver')">ë„¤ì´ë²„í˜ì´</button>
    <button onclick="requestBilling('payco')">í˜ì´ì½”</button>

    <div id="result" class="result" style="display:none;"></div>

    <!-- Payment Form -->
    <form id="payForm" method="POST" style="display:none;">
        <input type="hidden" name="version" value="1.0">
        <input type="hidden" name="mid" value="INIBillTst">
        <input type="hidden" name="oid" value="">
        <input type="hidden" name="price" value="0">
        <input type="hidden" name="timestamp" value="">
        <input type="hidden" name="signature" value="">
        <input type="hidden" name="mKey" value="">
        <input type="hidden" name="currency" value="WON">
        <input type="hidden" name="goodname" value="ì •ê¸°ê²°ì œ ì„œë¹„ìŠ¤">
        <input type="hidden" name="buyername" value="í™ê¸¸ë™">
        <input type="hidden" name="buyertel" value="01012341234">
        <input type="hidden" name="buyeremail" value="test@test.com">
        <input type="hidden" name="returnUrl" value="http://localhost:3000/billing-return">
        <input type="hidden" name="closeUrl" value="http://localhost:3000/close.html">
        <input type="hidden" name="gopaymethod" value="">
        <input type="hidden" name="acceptmethod" value="">
        <input type="hidden" name="charset" value="UTF-8">
        <input type="hidden" name="languageView" value="ko">
        <input type="hidden" name="payViewType" value="overlay">
        <input type="hidden" name="merchantData" value="">
    </form>

    <script>
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function getFormattedTimestamp() {
            const now = new Date();
            const pad = (n, length) => {
                let str = '' + n;
                while (str.length < length) {
                    str = '0' + str;
                }
                return str;
            };
            
            const yyyy = now.getFullYear().toString();
            const MM = pad(now.getMonth() + 1, 2);
            const dd = pad(now.getDate(), 2);
            const hh = pad(now.getHours(), 2);
            const mm = pad(now.getMinutes(), 2);
            const ss = pad(now.getSeconds(), 2);
            
            return yyyy + MM + dd + hh + mm + ss;
        }

        async function requestBilling(type) {
            const timestamp = Date.now().toString();
            const oid = "BILL_" + getFormattedTimestamp() + "_" + type.toUpperCase();
            const price = "0";
            
            // Set form values
            document.getElementsByName("oid")[0].value = oid;
            document.getElementsByName("timestamp")[0].value = timestamp;
            
            // Configure payment method based on type
            let gopaymethod = "";
            let acceptmethod = "";
            
            switch(type) {
                case 'auto':
                    // ìë™ì„ íƒ - ISPì™€ ì•ˆì‹¬í´ë¦­ ì¤‘ í•´ë‹¹ ì¹´ë“œì— ë§ëŠ” ê²ƒ ì„ íƒ
                    gopaymethod = "Card";
                    acceptmethod = "BILLAUTH(Card):below1000:no_receipt";
                    break;
                    
                case 'isp':
                    // ISP ì „ìš©
                    gopaymethod = "Card";
                    acceptmethod = "BILLAUTH(Card):ISP:below1000";
                    break;
                    
                case 'ansim':
                    // ì•ˆì‹¬í´ë¦­ ì „ìš©
                    gopaymethod = "Card";
                    acceptmethod = "BILLAUTH(Card):Ansim:below1000";
                    break;
                    
                case 'kakao':
                    gopaymethod = "onlykakaopay";
                    acceptmethod = "cardonly:BILLAUTH(Card)";
                    break;
                    
                case 'naver':
                    gopaymethod = "onlynaverpay";
                    acceptmethod = "cardonly:BILLAUTH(Card)";
                    break;
                    
                case 'payco':
                    gopaymethod = "onlypayco";
                    acceptmethod = "cardonly:BILLAUTH(Card)";
                    break;
            }
            
            document.getElementsByName("gopaymethod")[0].value = gopaymethod;
            document.getElementsByName("acceptmethod")[0].value = acceptmethod;
            
            // Set merchant data
            document.getElementsByName("merchantData")[0].value = JSON.stringify({
                type: type,
                billingType: "subscription"
            });
            
            // Generate keys
            const signKey = "SU5JTElURV9UUklQTEVERVNfS0VZU1RS";
            const mKey = await sha256(signKey);
            document.getElementsByName("mKey")[0].value = mKey;
            
            // Generate signature
            const signatureData = "oid=" + oid + "&price=" + price + "&timestamp=" + timestamp;
            const signature = await sha256(signatureData);
            document.getElementsByName("signature")[0].value = signature;
            
            // Show what we're doing
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>ìš”ì²­ ì •ë³´</h3>
                <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${oid}</p>
                <p><strong>ê²°ì œë°©ë²•:</strong> ${gopaymethod}</p>
                <p><strong>ì¸ì¦ë°©ë²•:</strong> ${acceptmethod}</p>
                <p><strong>ìƒíƒœ:</strong> ê²°ì œì°½ í˜¸ì¶œ ì¤‘...</p>
            `;
            
            console.log("Billing request:", {
                type: type,
                oid: oid,
                gopaymethod: gopaymethod,
                acceptmethod: acceptmethod
            });
            
            try {
                INIStdPay.pay('payForm');
            } catch (e) {
                console.error("Error:", e);
                resultDiv.innerHTML += `<p style="color: red;"><strong>ì˜¤ë¥˜:</strong> ${e.message}</p>`;
            }
        }

        // Listen for billing result
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'billing_key_result') {
                const params = event.data.params;
                const resultDiv = document.getElementById('result');
                
                if (params.resultCode === '0000' && params.billKey) {
                    resultDiv.innerHTML += `
                        <hr>
                        <h3 style="color: green;">âœ… ë¹Œë§í‚¤ ë°œê¸‰ ì„±ê³µ!</h3>
                        <p><strong>ë¹Œë§í‚¤:</strong> ${params.billKey}</p>
                        <p><strong>ì¹´ë“œì •ë³´:</strong> ${params.cardInfo || 'ì¹´ë“œì •ë³´'}</p>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <hr>
                        <h3 style="color: red;">âŒ ë¹Œë§í‚¤ ë°œê¸‰ ì‹¤íŒ¨</h3>
                        <p><strong>ì˜¤ë¥˜:</strong> ${params.resultMsg || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
                    `;
                }
            }
        });
    </script>
</body>
</html>